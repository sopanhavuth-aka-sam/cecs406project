<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Interactive BarChart</title>
		<script src="http://d3js.org/d3.v3.min.js"></script>
		<style>
		</style>
	</head>
		<body>
		
			<div id="demo">
				<div id="userInput">
					<button id="top10Button">Top 10</button>
					<br>
					<label><input type="checkbox" id="hispanicCheckBox" >Hispanic</label>
					<label><input type="checkbox" id="asianCheckBox" >Asian</label>
					<label><input type="checkbox" id="blackCheckBox" >Black</label>
					<label><input type="checkbox" id="whiteCheckBox" >White</label>
				</div>
				<svg id="svg-barchart"></svg>
			</div>
			
			<script>
				var selectedNames = [];
				//variables to store 2 top ten name
				//(20 total = top 10 males and top 10 female) in each race
				var topHispanic = [];
				var topAsian = [];
				var topBlack = [];
				var topWhite = [];

				//parsing and searching
				d3.csv("clean-babyNameDB.csv", function(error, dataSet) {
					//type conversion (string to int); search for top name
					dataSet.forEach(function(d) {
						d.BRTH_YR = +d.BRTH_YR;
						d.CNT = +d.CNT;
						d.RNK = +d.RNK;
						d.enabled = true;

						if("HISPANIC".localeCompare(d.ETHCTY) == 0 && d.RNK <= 10) {
							topHispanic.push(d);
						}
						else if("ASIAN AND PACIFIC ISLANDER".localeCompare(d.ETHCTY) == 0 && d.RNK <= 10) {
							topAsian.push(d);
						} 
						else if("BLACK NON HISPANIC".localeCompare(d.ETHCTY) == 0 && d.RNK <= 10) {
							topBlack.push(d);
						} 
						else if("WHITE NON HISPANIC".localeCompare(d.ETHCTY) == 0 && d.RNK <= 10) {
							topWhite.push(d);
						}
					});//end: type conversion; search for top name
				});//end: parsing and searching
			
				//////////////////////////////////guideline for script seperation later on/////////////////////////////////////////////////////
				//combine 'top' arrys based on what option is checked in userInput
				function combineRace() {
				console.log("hello1");
					var selectedNames = [];
					if(document.getElementById("hispanicCheckBox").checked) {
						selectedNames = selectedNames.concat(topHispanic);
					}
					if(document.getElementById("asianCheckBox").checked) {
						selectedNames = selectedNames.concat(topAsian);
					}
					if(document.getElementById("blackCheckBox").checked) {
						selectedNames = selectedNames.concat(topBlack);
					}
					if(document.getElementById("whiteCheckBox").checked) {
						selectedNames = selectedNames.concat(topWhite);
					}
					return selectedNames;
				}//end: combineRace
				
				//update "selectedNames" array when button is clicked.
				document.getElementById('top10Button').onclick = function() {
					selectedNames = combineRace();
					//TEST: sort selectedNames
					selectedNames.sort(function(a,b) {
								return parseInt(b.CNT, 10) - parseInt(a.CNT, 10); 
							});
					console.log(selectedNames);
					selectedNames = topN(selectedNames, 10);
					console.log(selectedNames);
					bars(selectedNames);
				};
				
				//Filter function base on 'count' property of each name
				//param: array (that need to be filter), N (e.g. 10, 20 -> return top 10, top 20 names)
				function topN(nameArr, N) {
					var topArr = []; //store top names to return to caller
					
					//iterate thourgh all the name
					for(i = 0; i < nameArr.length; i++) {
						if (i < N) { //topArr is !full(N elements) -> push to element
							topArr.push(nameArr[i]);
						}
						else if(topArr.length == N) { //sort topArr base on name's element: CNT
							topArr.sort(function(a,b) {
								return parseInt(b.CNT, 10) - parseInt(a.CNT, 10); 
							});
						}
						//topArr is full
						//-> compare new element to smallest topArr's element (last index)
						//-> if new element is larger, replace ir
						//-> re-sort
						//-> else, do nothing
						else {
							if(topArr[topArr.length - 1].CNT < nameArr[i].CNT) {
								//replace element
								topArr[topArr.length - 1] = nameArr[i];
								//re-sort
								topArr.sort(function(a,b) {
									return parseInt(b.CNT, 10) - parseInt(a.CNT, 10); 
								});
							}
							//else, do nothing
						}
					}
					return topArr;
				}//end: topN
				///////////////////////////////////////Draw BarChart(bar.js)//////////////////////////////
				
				var w = 500;
				var h = 400;
				
				//setup the svg
				var svg = d3.select("#svg-barchart")
					.attr("width", w+100)
					.attr("height", h+100);
					
				svg.append("svg:rect")
					.attr("width", "100%")
					.attr("height", "100%")
					.attr("stroke", "#000")
					.attr("fill", "none");

				svg.append("svg:g")
					.attr("id", "barchart")
					.attr("transform", "translate(50,50)");
					
				svg.append("svg:text")
					.attr("dy", ".35em");
					
				
				function bars(data) {
					
					var padding = 40;// So we can see label at the right of the bar
					
					//max: the largest CNT within the array of Names
					max = d3.max(data, function(d) { return d.CNT; }) + padding;
					
					//set x scale
					x = d3.scale.linear()
						.domain([0, max])
						.range([0, w]);
					
					//set y scale
					y = d3.scale.ordinal()
						.domain(d3.range(data.length))
						.rangeBands([0, h], .2);


					var vis = d3.select("#barchart");
					
					var bars = vis.selectAll("rect.bar")
						.data(data);

					//update
//					bars
//						.attr("fill", "#0a0")
//						.attr("stroke", "#050");

					//enter
					bars.enter()
						.append("svg:rect")
						.attr("class", "bar")
						.attr("fill", "#0a0")
						.attr("stroke", "#050");


					//exit 
					bars.exit()
					.transition()
					.duration(300)
					.ease("exp")
						.attr("width", 0)
						.remove();

					//Draw new bars
					bars
						.attr("stroke-width", 4)
						.transition()
						.duration(300)
						.ease("quad")
						.attr("width", function(d) { return x(d.CNT); })
						.attr("height", y.rangeBand())
						.attr("transform", function(d,i) {
							return "translate(" + [0, y(i)] + ")";
						});
						//new code for text
					console.log("text1");
//					var label = vis.selectAll("g")
//									.data(data)
//									.enter().append("g")
//									.attr("transform", function(d, i) { 
//										return "translate(" + [0, y(i)] + ")"
//									});
//									
//					var labels = label.append("text")
//						.attr("x", function(d) { return x(d.CNT) + 3; })
//						.attr("y", y.rangeBand()/2)
//						.attr("dy", ".35em")
//						.text(function(d) { 
//							return d.NM + " " + d.CNT; 
//						});

					//var labels = vis.selectAll("g")
					var labels = vis.selectAll("text")
									.data(data);
									
					//enter
					labels.enter()
						//.append("g")
						.append("text")
						.attr("transform", function(d, i) { 
							return "translate(" + [0, y(i)] + ")"
						});
						
					//exit
					labels.exit().remove();
					
					//draw new labels
					labels//.append("text")
//						.attr("transform", function(d, i) { 
//								return "translate(" + [0, y(i)] + ")"
//						})
						.attr("x", function(d) { return x(d.CNT) + 3; })
						.attr("y", y.rangeBand()/2)
						.attr("dy", ".35em")
						.text(function(d) { 
							return d.NM + " " + d.CNT; 
						});
					
					console.log("text2");
				}
		</script>
	</body>
</html>