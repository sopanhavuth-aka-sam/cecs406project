<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Interactive BarChart</title>
		<script src="http://d3js.org/d3.v3.min.js"></script>
		<style>
			#svg-piechart {
				height: 360px;
				margin: 0 auto;                                              
				position: fixed;
				width: 360px;
				padding-left: 50px;
			}
			label{
				display: inline-block;
				padding-top: 5px;
				padding-bottom: 5px;
				padding-left: 5px;
				padding-right: 8px;
			}
			.axis path,
			.axis line {
			   fill: none;
			   stroke: #000;
			   shape-rendering: crispEdges;
			}
		</style>
	</head>
		<body>
		
			<div id="chart", style="display:block">
				<div id="userInput">
					<button id="top10Button">Top 10</button>
					<button id="top20Button">Top 20</button>
					<button id="top30Button">Top 30</button>
					<button id="top40Button">Top 40</button>
					<br>
					<br>
					<label style="background-color: #1f77b4"><input type="checkbox" id="hispanicCheckBox" >Hispanic</label>
					<label style="background-color: #ff7f0e"><input type="checkbox" id="asianCheckBox" >Asian</label>
					<label style="background-color: #2ca02c"><input type="checkbox" id="blackCheckBox" >Black</label>
					<label style="background-color: #d62728"><input type="checkbox" id="whiteCheckBox" >White</label>
				</div>
				<svg id="svg-barchart"></svg>
				<svg id="svg-piechart"></svg>
			</div>
			
			<script>
				//clear checkbox input
				document.getElementById("hispanicCheckBox").checked = false;
				document.getElementById("asianCheckBox").checked = false;
				document.getElementById("blackCheckBox").checked = false;
				document.getElementById("whiteCheckBox").checked = false;
				//store selected names
				var selectedNames = [];
				//variables to store 2 top N (10, 20, 30) name
				var topHispanic = [];
				var topAsian = [];
				var topBlack = [];
				var topWhite = [];

				//parsing and searching
				d3.csv("clean-babyNameDB.csv", function(error, dataSet) {
					//type conversion (string to int); search for top name
					dataSet.forEach(function(d) {
						d.BRTH_YR = +d.BRTH_YR;
						d.CNT = +d.CNT;
						d.RNK = +d.RNK;
						d.enabled = true;
						
						var maxRank = 40;
						
						if("HISPANIC".localeCompare(d.ETHCTY) == 0 && d.RNK <= maxRank) {
							topHispanic.push(d);
						}
						else if("ASIAN AND PACIFIC ISLANDER".localeCompare(d.ETHCTY) == 0 && d.RNK <= maxRank) {
							topAsian.push(d);
						} 
						else if("BLACK NON HISPANIC".localeCompare(d.ETHCTY) == 0 && d.RNK <= maxRank) {
							topBlack.push(d);
						} 
						else if("WHITE NON HISPANIC".localeCompare(d.ETHCTY) == 0 && d.RNK <= maxRank) {
							topWhite.push(d);
						}
					});//end: type conversion; search for top name
				});//end: parsing and searching
			
				//////////////////////////////////guideline for script seperation later on/////////////////////////////////////////////////////
				//combine 'top' arrys based on what option is checked in userInput
				function combineRace() {
					var selectedNames = [];
					if(document.getElementById("hispanicCheckBox").checked) {
						selectedNames = selectedNames.concat(topHispanic);
					}
					if(document.getElementById("asianCheckBox").checked) {
						selectedNames = selectedNames.concat(topAsian);
					}
					if(document.getElementById("blackCheckBox").checked) {
						selectedNames = selectedNames.concat(topBlack);
					}
					if(document.getElementById("whiteCheckBox").checked) {
						selectedNames = selectedNames.concat(topWhite);
					}
					return selectedNames;
				}//end: combineRace
				
				//Top 10 Button: update and draw "selectedNames" array when button is clicked.
				document.getElementById('top10Button').onclick = function() {
					//get names array base on user's seleted race
					selectedNames = combineRace();
					//sort names array base on CNT(count)
					selectedNames.sort(function(a,b) {
								return parseInt(b.CNT, 10) - parseInt(a.CNT, 10); 
							});
					console.log(selectedNames);//FOR DEBUGGING
					//Filter top 10 within names array
					selectedNames = topN(selectedNames, 10);
					console.log(selectedNames);//FOR DEBUGGING
					//draw barchart
					bars(selectedNames);
					//draw piechart
					pie(pieData(selectedNames));
				};
				
				//Top 20 Button: update and draw "selectedNames" array when button is clicked.
				document.getElementById('top20Button').onclick = function() {
					//get names array base on user's seleted race
					selectedNames = combineRace();
					//sort names array base on CNT(count)
					selectedNames.sort(function(a,b) {
								return parseInt(b.CNT, 10) - parseInt(a.CNT, 10); 
							});
					console.log(selectedNames);//FOR DEBUGGING
					//Filter top 10 within names array
					selectedNames = topN(selectedNames, 20);
					console.log(selectedNames);//FOR DEBUGGING
					//draw barchart
					bars(selectedNames);
					//draw piechart
					pie(pieData(selectedNames));
				};
				
				//Top 30 Button: update and draw "selectedNames" array when button is clicked.
				document.getElementById('top30Button').onclick = function() {
					//get names array base on user's seleted race
					selectedNames = combineRace();
					//sort names array base on CNT(count)
					selectedNames.sort(function(a,b) {
								return parseInt(b.CNT, 10) - parseInt(a.CNT, 10); 
							});
					console.log(selectedNames);//FOR DEBUGGING
					//Filter top 10 within names array
					selectedNames = topN(selectedNames, 30);
					console.log(selectedNames);//FOR DEBUGGING
					//draw barchart
					bars(selectedNames);
					//draw piechart
					pie(pieData(selectedNames));
				};
				
				//Top 40 Button: update and draw "selectedNames" array when button is clicked.
				document.getElementById('top40Button').onclick = function() {
					//get names array base on user's seleted race
					selectedNames = combineRace();
					//sort names array base on CNT(count)
					selectedNames.sort(function(a,b) {
								return parseInt(b.CNT, 10) - parseInt(a.CNT, 10); 
							});
					console.log(selectedNames);//FOR DEBUGGING
					//Filter top 10 within names array
					selectedNames = topN(selectedNames, 40);
					console.log(selectedNames);//FOR DEBUGGING
					//draw barchart
					bars(selectedNames);
					//draw piechart
					pie(pieData(selectedNames));
				};
				
				//Filter function base on 'count' property of each name
				//param: array (that need to be filter), N (e.g. 10, 20 -> return top 10, top 20 names)
				function topN(nameArr, N) {
					var topArr = []; //store top names to return to caller
					
					//iterate thourgh all the name
					for(i = 0; i < nameArr.length; i++) {
						if (i < N) { //topArr is !full(N elements) -> push to element
							topArr.push(nameArr[i]);
						}
						else if(topArr.length == N) { //sort topArr base on name's element: CNT
							topArr.sort(function(a,b) {
								return parseInt(b.CNT, 10) - parseInt(a.CNT, 10); 
							});
						}
						//topArr is full
						//-> compare new element to smallest topArr's element (last index)
						//-> if new element is larger, replace ir
						//-> re-sort
						//-> else, do nothing
						else {
							if(topArr[topArr.length - 1].CNT < nameArr[i].CNT) {
								//replace element
								topArr[topArr.length - 1] = nameArr[i];
								//re-sort
								topArr.sort(function(a,b) {
									return parseInt(b.CNT, 10) - parseInt(a.CNT, 10); 
								});
							}
							//else, do nothing
						}
					}
					return topArr;
				}//end: topN
				///////////////////////////////////////Draw BarChart(bar.js)//////////////////////////////	
				
				function bars(data) {
					
					var w = 600;
					var h = 500;
					var padding = 100;
					//setup the svg
					var svg = d3.select("#svg-barchart")
						.attr("width", w+padding)
						.attr("height", h+padding);
						
					svg.append("svg:rect")
						.attr("width", "100%")
						.attr("height", "100%")
						.attr("stroke", "#000")
						.attr("fill", "none");

					svg.append("svg:g")
						.attr("id", "barchart")
						.attr("transform", "translate(50,50)");
						
					svg.append("svg:text")
						.attr("dy", ".35em");
					
					var padding = 40;// So we can see label at the right of the bar
					
					//max: the largest CNT within the array of Names
					max = d3.max(data, function(d) { return d.CNT; }) + padding;
					
					//set x scale
					x = d3.scale.linear()
						.domain([0, max])
						.range([0, w]);
					
					//set y scale
					y = d3.scale.ordinal()
						.domain(d3.range(data.length))
						.rangeBands([0, h], .2);

					//set up axis
					var xAxis = d3.svg.axis()
									.scale(x)
									.orient("bottom");
					
					//draw axis				
					d3.select("#barchart")
						.append("g")
						.attr("class", "x axis")
						.attr("transform", "translate(0," + h + ")")
						.call(xAxis);
						
					var vis = d3.select("#barchart");
					
					var bars = vis.selectAll("rect.bar")
						.data(data);

					//enter
					bars.enter()
						.append("svg:rect")
						.attr("class", "bar")
						.attr("stroke", "#050");


					//exit 
					bars.exit()
					.transition()
					.duration(300)
					.ease("exp")
						.attr("width", 0)
						.remove();

					//Draw new bars
					bars
						.attr("stroke-width", 4)
						.transition()
						.duration(300)
						.ease("quad")
//						.attr("x", function(d) { return x(d.CNT); })
						.attr("width", function(d) { return x(d.CNT); })
						.attr("height", y.rangeBand())
						.attr("transform", function(d,i) {
							return "translate(" + [0, y(i)] + ")";
						})
						.attr("fill", function(d){
							return ethnicityColor(d.ETHCTY);
						});
					
					//remove all previous text
					var removeLable = d3.selectAll("text").remove();
					
					//var labels = vis.selectAll("g")
					var labels = vis.selectAll("text")
									.data(data);
									
					//enter
					labels.enter()
						.append("text")
						.attr("transform", function(d, i) { 
							return "translate(" + [0, y(i)] + ")"
						});
						
					//exit
					labels.exit().remove();
					
					//draw new labels
					labels
						.attr("x", function(d) { return x(d.CNT) + 3; })
						.attr("y", y.rangeBand()/2)
						.attr("dy", ".35em")
						.attr("font-size", 15)
						.text(function(d) { 
							return d.NM + " " + d.CNT; 
						});
					
					//testing tooltip
					
					
					//color() function: assign color to bar base on ethnicity
					function ethnicityColor(ethnicity) {
						if("HISPANIC".localeCompare(ethnicity) == 0) {
							return ("#1f77b4");
						}
						else if("ASIAN AND PACIFIC ISLANDER".localeCompare(ethnicity) == 0) {
							return ("#ff7f0e");
						} 
						else if("BLACK NON HISPANIC".localeCompare(ethnicity) == 0) {
							return ("#2ca02c");
						} 
						else if("WHITE NON HISPANIC".localeCompare(ethnicity) == 0 ) {
							return ("#d62728");
						}
					}//end: ethnicityColor
				}
				
				//pieData: param: selectedNames array
				//			return: a 2-element array of {ethic name, total babies in the ethic}
				function pieData(data) {
					//var newData = [];
					var hispanicCount = 0, asianCount = 0, whiteCount = 0, blackCount = 0;
					
					//store ethic(label) and totalCount: sum of same ethic baby(count)
					data.forEach (function(d) {
						if("HISPANIC".localeCompare(d.ETHCTY) == 0) {
							hispanicCount += d.CNT;
						}
						else if("ASIAN AND PACIFIC ISLANDER".localeCompare(d.ETHCTY) == 0) {
							asianCount += d.CNT;
						} 
						else if("BLACK NON HISPANIC".localeCompare(d.ETHCTY) == 0) {
							blackCount += d.CNT;
						} 
						else if("WHITE NON HISPANIC".localeCompare(d.ETHCTY) == 0) {
							whiteCount += d.CNT;
						}
					  });
					  
					return newData = [
					  { label: 'Hispanic', count: hispanicCount }, 
					  { label: 'Asian', count: asianCount },
					  { label: 'Black', count: blackCount },
					  { label: 'White', count: whiteCount }
					];
				}//end: pieData
				
				//pie: param: returned array from pieData
				// 		Draw pie on page.
				function pie(data) {
				
					var width = 360;
					var height = 360;
					var radius = Math.min(width, height) / 2; //radius is calculated base on the mininum of "width" and "height"
					var color = d3.scale.category10();
					
					var svg = d3.select("#svg-piechart")
								.attr("width",width)
								.attr("height", height)
								.append("g")
								.attr('transform', 'translate(' + (width / 2) + 
									',' + (height / 2) + ')');
					
					var arc = d3.svg.arc()
						.innerRadius(0)
						.outerRadius(radius);
					
					var pie = d3.layout.pie()
						.value(function(d) { return d.count; })
						.sort(null);
					  
					var tooltip = d3.select("body")
									.append("div")
									.style("position", "absolute")
									.style("z-index", "10")
									.style("visibility", "hidden")
									.style("background-color", "white");
									
				
					var path = svg.selectAll('path')
						.data(pie(data));
					
					//enter
					path
						.enter()
						.append('path')
						.attr('d', arc)
						.attr('fill', function(d, i) { 
						  return color(d.data.label); 
						})                             
						.each(function(d) { this._current = d; });   
					
					//exit
					path.exit().remove();

					path.on('mouseover', function(d) {
						var total = d3.sum(data.map(function(d) {
						  return d.count;
						}));
						var percent = Math.round(1000 * d.data.count / total) / 10; 
						tooltip.style('visibility', 'visible');
						tooltip.text(d.data.label + " " + percent + "%" + "(" + d.data.count + ")");
					});
					  
					path.on('mouseout', function() {
						tooltip.style('visibility', 'hidden');
					});
					path.on("mousemove", function(){
						tooltip.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");
					});
					

				}//end: pie
				
		</script>
	</body>
</html>